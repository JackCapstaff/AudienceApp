<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Audience View</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js"
          integrity="sha512-N5JbZMETkl+0SZh5l8OA2VxSfF120owfQyy54iAXTJIKuqAn3A9TrNz1ypB55o8aSU5MxaodEgv74wGUvgUynQ=="
          crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden;
      background: black;
    }
    #slide-img, #media-player, #black-overlay {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: contain;
    }
    #media-player {
      display: none;
    }
    #black-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: black;
      display: block;
      opacity: 0;
      transition: opacity 0.8s ease;
      z-index: 5;
    }
    #black-overlay.blackened { opacity: 1; }
    #black-overlay.fade-in { opacity: 1; transition: opacity 0.05s ease; }
    #poll {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: none;
      background: rgba(0,0,0,0.8);
      color: white; font-family: sans-serif;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      padding: 1rem; box-sizing: border-box;
      z-index: 10;
    }
    #poll h1 { margin: 0 0 1rem; font-size: 2rem; text-align: center; }
    #poll-options button {
      margin: 0.5rem; padding: 0.75rem 1.5rem;
      font-size: 1.2rem; cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Holding slide on load -->
  <img id="slide-img" src="/static/slides/holdingslide.jpg" alt="Holding Slide"/>

  <!-- Video player -->
  <video id="media-player" playsinline webkit-playsinline>
    <source id="media-source" src="" type="video/mp4">
    Your browser doesnâ€™t support HTML5 video.
  </video>

  <!-- Black overlay -->
  <div id="black-overlay"></div>

  <!-- Poll overlay -->
  <div id="poll">
    <h1 id="poll-question"></h1>
    <div id="poll-options"></div>
  </div>

  <script>
    const socket = io({
      transports: ['websocket'],
      upgrade: false,
      secure: true
    });

    const slideImg     = document.getElementById('slide-img');
    const mediaPlayer  = document.getElementById('media-player');
    const mediaSource  = document.getElementById('media-source');
    const blackOverlay = document.getElementById('black-overlay');
    const pollOverlay  = document.getElementById('poll');
    const pollQuestion = document.getElementById('poll-question');
    const pollOptions  = document.getElementById('poll-options');

    // === Live sync for ALL late joiners and updates ===
    // This function sets up the correct view (slide/video) using ALL state fields.
    function updateView(asset) {
      pollOverlay.style.display = 'none';
      blackOverlay.classList.remove('blackened');
      if (asset.type === 'slide') {
        // Show slide
        mediaPlayer.pause(); mediaPlayer.style.display = 'none';
        slideImg.style.display = 'block';
        slideImg.src = `/static/slides/${asset.name}`;
      } else if (asset.type === 'video') {
        slideImg.style.display = 'none';
        mediaSource.src = `/static/media/${asset.name}`;
        mediaPlayer.load();
        mediaPlayer.style.display = 'block';
        mediaPlayer.onloadedmetadata = function() {
          // Apply time/paused/speed correctly, robust for late joiners!
          mediaPlayer.currentTime = asset.video_time || 0;
          mediaPlayer.playbackRate = asset.video_speed || 1.0;
          if (!asset.video_paused || asset.autoplay) {
            mediaPlayer.play().catch(()=>{});
          } else {
            mediaPlayer.pause();
          }
        };
      }
    }

    // On connect, get FULL state for late joiners
    socket.on("connect", () => {
      // Nothing to do: server will send 'sync_state'
    });
    socket.on("sync_state", updateView);
    socket.on("display_asset", updateView);

    // Fade-to-black support
    socket.on('fade_to_black', () => {
      blackOverlay.classList.add('blackened');
    });

    // Poll support (unchanged from original)
    socket.on('new_poll', p => {
      slideImg.style.display = 'none';
      mediaPlayer.pause(); mediaPlayer.style.display = 'none';
      pollQuestion.textContent = p.question;
      pollOptions.innerHTML = '';
      Object.keys(p.options).forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.onclick = () => {
          socket.emit('vote', { poll_id: p.id, option: opt });
          pollOptions.querySelectorAll('button')
            .forEach(b => b.disabled = true);
        };
        pollOptions.appendChild(btn);
      });
      pollOverlay.style.display = 'flex';
    });
    socket.on('poll_closed', () => {
      pollOverlay.style.display = 'none';
      slideImg.style.display = 'block';
    });

    // Play/Pause (from server only)
    socket.on('play_pause_video', asset => {
      if (mediaPlayer.style.display === 'block') {
        mediaPlayer.currentTime = asset.video_time || 0;
        mediaPlayer.playbackRate = asset.video_speed || 1.0;
        if (!asset.video_paused) {
          mediaPlayer.play().catch(()=>{});
        } else {
          mediaPlayer.pause();
        }
      }
    });

    // Set playback speed (from server only)
    socket.on('set_playback_speed', ({speed}) => {
      mediaPlayer.playbackRate = speed;
    });

    // Seek (from server only)
    socket.on('seek_video', ({time}) => {
      if (mediaPlayer.style.display === 'block') {
        mediaPlayer.currentTime = time;
      }
    });

    // Stop media (if you emit this)
    socket.on('stop_media', () => {
      mediaPlayer.pause(); mediaPlayer.currentTime = 0;
      mediaPlayer.style.display = 'none';
      slideImg.style.display = 'block';
    });

    // Existing slide paging (legacy, if still used)
    function showSlide(index) {
      pollOverlay.style.display = 'none';
      mediaPlayer.pause(); mediaPlayer.currentTime = 0;
      mediaPlayer.style.display = 'none';
      slideImg.style.display = 'block';
      slideImg.onerror = null;
      // try jpg then png
      const jpg = `/static/slides/slide${index+1}.jpg`;
      slideImg.src = jpg;
      slideImg.onerror = () => {
        slideImg.onerror = null;
        slideImg.src = `/static/slides/slide${index+1}.png`;
      };
    }
    socket.on('slide_update', ({index}) => showSlide(index));

    // (Unused) fade-in reveal, if you re-enable this
    function revealFade() {
      blackOverlay.style.opacity = '0';
      blackOverlay.addEventListener('transitionend', () => {
        blackOverlay.style.display = 'none';
      }, { once: true });
    }
  </script>
</body>
</html>
