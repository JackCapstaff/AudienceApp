<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Audience View</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js" integrity="sha512-N5JbZMETkl+0SZh5l8OA2VxSfF120owfQyy54iAXTJIKuqAn3A9TrNz1ypB55o8aSU5MxaodEgv74wGUvgUynQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    html, body {
      margin: 0; padding: 0; height: 100%; overflow: hidden;
      background: black;
    }
    #slide-img, #media-player, #black-overlay {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
      object-fit: contain;
    }
    #media-player {
      display: none;
    }
    #black-overlay {
      position: absolute;
      top: 0; left: 0;
      width: 100vw; height: 100vh;
      background: black;
      display: block; /* Changed from 'none' */
      opacity: 0;
      transition: opacity 0.8s ease;
      z-index: 5;
    }
    #black-overlay.blackened {
      opacity: 1;
    }
    #black-overlay.fade-in {
        opacity: 1;
        transition: opacity 0.05s ease; /* Short transition */
    }
    #poll {
      position: absolute; top: 0; left: 0;
      width: 100vw; height: 100vh;
      display: none;
      background: rgba(0,0,0,0.8);
      color: white; font-family: sans-serif;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
      padding: 1rem; box-sizing: border-box;
      z-index: 10;
    }
    #poll h1 { margin: 0 0 1rem; font-size: 2rem; text-align: center; }
    #poll-options button {
      margin: 0.5rem; padding: 0.75rem 1.5rem;
      font-size: 1.2rem; cursor: pointer;
    }
  </style>
</head>
<body>
  <!-- Holding slide on load -->
  <img id="slide-img" src="/static/slides/holdingslide.jpg" alt="Holding Slide"/>

  <!-- Video player -->
  <video id="media-player"
         playsinline webkit-playsinline controls>
    <source id="media-source" src="" type="video/mp4">
    Your browser doesn’t support HTML5 video.
  </video>

  <!-- Black overlay -->
  <div id="black-overlay"></div>

  <!-- Poll overlay -->
  <div id="poll">
    <h1 id="poll-question"></h1>
    <div id="poll-options"></div>
  </div>

  <script>
    

    const socket = io({
    transports: ['websocket'],
    upgrade: false,
    secure: true
    });
    console.log("🔗 socket.io client loaded (ws only)");

    socket.on("connect", () => {
      console.log("🟢 socket connected, id=", socket.id);
    });
    socket.on("connect_error", (err) => {
      console.error("❌ Socket connect_error:", err);
    });

    
    const slideImg     = document.getElementById('slide-img');
    const mediaPlayer  = document.getElementById('media-player');
    const mediaSource  = document.getElementById('media-source');
    const blackOverlay = document.getElementById('black-overlay');
    const pollOverlay  = document.getElementById('poll');
    const pollQuestion = document.getElementById('poll-question');
    const pollOptions  = document.getElementById('poll-options');

    // 1) Slide-paging helper
    function showSlide(index) {
      // hide video & poll
      pollOverlay.style.display = 'none';
      mediaPlayer.pause(); mediaPlayer.currentTime = 0;
      mediaPlayer.style.display = 'none';

      slideImg.style.display = 'block';
      slideImg.onerror = null;

      // try jpg then png
      const jpg = `/static/slides/slide${index+1}.jpg`;
      slideImg.src = jpg;
      slideImg.onerror = () => {
        slideImg.onerror = null;
        slideImg.src = `/static/slides/slide${index+1}.png`;
      };
    }
    socket.on('slide_update', ({index}) => showSlide(index));

    // 2) Fade-to-black
    socket.on('fade_to_black', () => {
      blackOverlay.classList.add('blackened');
    });

    // 3) Fade-in after black (used by display_asset)
    function revealFade() {
      blackOverlay.style.opacity = '0';
      blackOverlay.addEventListener('transitionend', () => {
        blackOverlay.style.display = 'none';
      }, { once: true });
    }

    // 4) Generic asset handler
    socket.on('display_asset', ({ type, name, autoplay, fadeIn }) => {
      pollOverlay.style.display = 'none';

      // New code: Remove the 'blackened' class if it exists
      blackOverlay.classList.remove('blackened');

      if (type === 'slide') {
        mediaPlayer.pause();
        mediaPlayer.style.display = 'none';

        slideImg.src = `/static/slides/${name}`;
        slideImg.style.display = 'block';

        if (fadeIn) {
          blackOverlay.classList.add('fade-in'); // Add a class for fading in
          setTimeout(() => {
            blackOverlay.classList.remove('fade-in');
          }, 50);
        }
      } else if (type === 'video') {
        slideImg.style.display = 'none';

        mediaSource.src = `/static/media/${name}`;
        mediaPlayer.load();
        mediaPlayer.style.display = 'block';

        if (fadeIn) {
          blackOverlay.classList.add('fade-in'); // Add a class for fading in
          setTimeout(() => {
            blackOverlay.classList.remove('fade-in');
            if (autoplay) {
              mediaPlayer.muted = true;
              mediaPlayer.play().catch(console.warn);
            }
          }, 50);
        } else if (autoplay) {
          mediaPlayer.muted = true;
          mediaPlayer.play().catch(console.warn);
        } else {
          mediaPlayer.muted = false;
        }
      }
    });

    // 5) Stop media (if you emit this)
    socket.on('stop_media', () => {
      mediaPlayer.pause(); mediaPlayer.currentTime = 0;
      mediaPlayer.style.display = 'none';
      slideImg.style.display = 'block';
    });

    // 6) Polling
    socket.on('new_poll', p => {
      slideImg.style.display = 'none';
      mediaPlayer.pause(); mediaPlayer.style.display = 'none';

      pollQuestion.textContent = p.question;
      pollOptions.innerHTML = '';
      Object.keys(p.options).forEach(opt => {
        const btn = document.createElement('button');
        btn.textContent = opt;
        btn.onclick = () => {
          socket.emit('vote', { poll_id: p.id, option: opt });
          pollOptions.querySelectorAll('button')
            .forEach(b => b.disabled = true);
        };
        pollOptions.appendChild(btn);
      });
      pollOverlay.style.display = 'flex';
    });
    socket.on('poll_closed', () => {
      pollOverlay.style.display = 'none';
      slideImg.style.display = 'block';
    });

    // 7) Trigger play for an already‐loaded video
    socket.on('play_pause_video', () => {
      if (mediaPlayer.style.display === 'block') {
        if (mediaPlayer.readyState >= 2) { // Check if metadata is loaded
          if (mediaPlayer.paused) {
            mediaPlayer.play().catch(console.warn);
          } else {
            mediaPlayer.pause();
          }
        } else {
          // If metadata is not loaded, wait for it
          mediaPlayer.addEventListener('loadedmetadata', () => {
            if (mediaPlayer.paused) {
              mediaPlayer.play().catch(console.warn);
            } else {
              mediaPlayer.pause();
            }
          }, { once: true }); // Only listen once
        }
      }
    });

    socket.on('set_playback_speed', (data) => {
      mediaPlayer.playbackRate = data.speed;
    });
  </script>
</body>
</html>
