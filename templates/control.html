<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Control Panel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js"
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
  <style>
    body { font-family: sans-serif; padding:1rem; }
    h1 { margin-top: 0; }
    #top-controls button { margin-right:0.5rem; padding:0.5rem 1rem; }
    #asset-grid, #queue, #transition-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px,1fr));
      gap:0.5rem;
      margin: 0.5rem 0; border:1px solid #ccc; padding:0.5rem; min-height: 120px;
    }
    .asset-tile, .queue-tile, .transition-tile {
      position: relative; cursor: grab; border:2px solid transparent; border-radius:6px; overflow:hidden; background:#111;
      user-select: none;
    }
    .queue-tile.current { border-color:#007BFF; }
    .asset-tile img, .asset-tile video, .queue-tile img, .queue-tile video {
      width:100%; height:auto; object-fit:contain;
    }
    .tile-label {
      position:absolute; bottom:2px; left:2px; background:rgba(0,0,0,0.6); color:white;
      padding:1px 4px; font-size:0.75rem;
    }
    #send-options, #queue-controls { margin:0.5rem 0; }
    #send-options label, #queue-controls button { margin-right:0.5rem; }
    #preview-container, #current-audience-container {
      border: 1px solid #ccc; padding: 0.5rem; margin-bottom: 0.5rem; width: 50%; box-sizing: border-box;
    }
    #preview-area {
      display: flex; justify-content: space-between; width: 100%;
    }
    #current-audience-img, #current-audience-video, #preview-img, #preview-video {
      max-width: 100%; display: none;
    }
    #media-controls { margin-top: 1rem; }
    #media-scrubber { width: 220px; vertical-align: middle; }
    #media-time { font-family: monospace; margin-left: 0.4em; }
    .transition-label { font-weight:bold; letter-spacing: 1px; }
    #transition-box { border:2px dashed #888; margin-bottom:1rem; background:#222; padding:0.5rem; }
    #transition-box h3 { margin:0 0 0.3em 0; color:#ccc; font-size:1.1em;}
  </style>
</head>
<body>
  <h1>üéõÔ∏è Control Panel</h1>
  <div id="top-controls">
    <button id="black-button">Go to Black Screen</button>
    <button id="placeholder-button">Go to Placeholder</button>
    <button onclick="step(-1)">‚Üê Previous</button>
    <button onclick="step(1)">Next ‚Üí</button>
  </div>

  <div id="crossfade-settings" style="margin:0.5em 0;">
    <label>Crossfade Duration:
      <input type="number" id="crossfade-duration" min="0.2" max="10" step="0.1" value="2.0" style="width:4em;">
      seconds
    </label>
  </div>

  <h2>Asset Library (drag into queue)</h2>
  <div id="asset-grid">
    {% for slide in slides %}
      <div class="asset-tile" draggable="true"
           data-type="slide" data-name="{{ slide }}">
        <img src="/static/slides/{{ slide }}" alt="{{ slide }}"/>
        <div class="tile-label">{{ slide }}</div>
      </div>
    {% endfor %}
    {% for vid in videos %}
      <div class="asset-tile" draggable="true"
           data-type="video" data-name="{{ vid }}">
        <video muted>
          <source src="/static/media/{{ vid }}" type="video/mp4">
        </video>
        <div class="tile-label">{{ vid }}</div>
      </div>
    {% endfor %}
  </div>

  <div id="transition-box">
    <h3>Transitions &amp; Cues (drag to queue):</h3>
    <div id="transition-grid">
      <div class="transition-tile" draggable="true" data-type="transition" data-name="fade_to_black">
        <div style="background:#000;width:100%;height:60px;display:flex;align-items:center;justify-content:center;">
          <span class="transition-label" style="color:white;">Fade to Black</span>
        </div>
      </div>
      <div class="transition-tile" draggable="true" data-type="transition" data-name="fade_from_black">
        <div style="background:#444;width:100%;height:60px;display:flex;align-items:center;justify-content:center;">
          <span class="transition-label" style="color:white;">Fade from Black</span>
        </div>
      </div>
      <div class="transition-tile" draggable="true" data-type="transition" data-name="crossfade">
        <div style="background:linear-gradient(90deg,#111,#fff,#111);width:100%;height:60px;display:flex;align-items:center;justify-content:center;">
          <span class="transition-label" style="color:black;">Crossfade</span>
        </div>
      </div>
      <div class="transition-tile" draggable="true" data-type="cue" data-name="autoplay_next">
        <div style="background:#005bb5;width:100%;height:60px;display:flex;align-items:center;justify-content:center;">
          <span class="transition-label" style="color:white;">Autoplay Next</span>
        </div>
      </div>
    </div>
  </div>

  <h2>Queue</h2>
  <div id="queue"></div>
  <div id="queue-controls">
    <button onclick="prevInQueue()">‚Üê Prev in Queue</button>
    <button onclick="nextInQueue()">Next in Queue ‚Üí</button>
  </div>

  <div id="send-options">
    <label><input type="checkbox" id="fadeout-checkbox"/> Fade Out to Black</label>
    <label><input type="checkbox" id="fadein-checkbox"/> Fade In from Black</label>
    <label><input type="checkbox" id="autoplay-checkbox"/> Autoplay videos</label>
    <button onclick="sendCurrent()">Send Current</button>
  </div>

  <div id="queue-presets">
    <button id="save-preset-button">Save Preset</button>
    <button id="load-preset-button">Load Preset</button>
  </div>

  <div id="media-controls">
    <button id="play-pause-button">Play/Pause</button>
    <label for="playback-speed">Playback Speed:</label>
    <input type="number" id="playback-speed" min="0.25" max="2.0" step="0.25" value="1.0">
    <input type="range" id="media-scrubber" min="0" max="100" step="0.1" value="0">
    <span id="media-time">00:00 / 00:00</span>
  </div>

  <div id="preview-area">
    <div id="current-audience-container">
      <h2>Current Audience View</h2>
      <img id="current-audience-img" alt="Current Audience Slide"/>
      <video id="current-audience-video" controls>
        <source id="current-audience-source" src="" type="video/mp4">
      </video>
    </div>
    <div id="preview-container">
      <h2>Preview</h2>
      <img id="preview-img" alt="Slide preview"/>
      <video id="preview-video" controls>
        <source id="preview-source" src="" type="video/mp4">
      </video>
    </div>
  </div>

  <script>
    const socket = io({ transports: ['websocket'], upgrade: false, secure: true });

    // Black & Placeholder
    document.getElementById('black-button').onclick = () => {
      socket.emit('transition', { name: 'fade_to_black' });
    };
    document.getElementById('placeholder-button').onclick = () => {
      socket.emit('display_asset', {
        type: 'slide',
        name: 'holdingslide.jpg',
        autoplay: false,
        fadeIn: false
      });
    };

    // Drag/Drop assets & transitions
    const assetTiles = document.querySelectorAll('.asset-tile');
    const transitionTiles = document.querySelectorAll('.transition-tile');
    const queueEl = document.getElementById('queue');
    let queue = [], currentIdx = -1;

    function handleTileDragStart(tile, type) {
      tile.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          type: tile.dataset.type,
          name: tile.dataset.name
        }));
      });
      tile.addEventListener('dblclick', () => {
        queue.push({ type: tile.dataset.type, name: tile.dataset.name });
        renderQueue();
      });
      tile.addEventListener('click', () => {
        if(type === "asset") previewQueueItem({ type: tile.dataset.type, name: tile.dataset.name });
      });
    }
    assetTiles.forEach(tile => handleTileDragStart(tile, "asset"));
    transitionTiles.forEach(tile => handleTileDragStart(tile, "transition"));

    queueEl.addEventListener('dragover', e => e.preventDefault());
    queueEl.addEventListener('drop', e => {
      e.preventDefault();
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      queue.push(data);
      renderQueue();
    });

    function renderQueue() {
      queueEl.innerHTML = '';
      queue.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'queue-tile' + (i === currentIdx ? ' current' : '');
        div.addEventListener('click', () => {
          currentIdx = i;
          renderQueue();
          previewQueueItem(item);
        });
        if (item.type === 'slide') {
          const img = document.createElement('img');
          img.src = `/static/slides/${item.name}`;
          div.appendChild(img);
        } else if (item.type === 'video') {
          const vid = document.createElement('video');
          vid.muted = true;
          vid.src = `/static/media/${item.name}`;
          div.appendChild(vid);
        } else if (item.type === 'transition' || item.type === 'cue') {
          let label = '';
          if (item.name === 'fade_to_black') label = 'Fade to Black';
          if (item.name === 'fade_from_black') label = 'Fade from Black';
          if (item.name === 'crossfade') label = 'Crossfade';
          if (item.name === 'autoplay_next') label = 'Autoplay Next';
          const div2 = document.createElement('div');
          div2.style.cssText = 'background:#000;width:100%;height:60px;display:flex;align-items:center;justify-content:center;';
          if(item.name === 'fade_from_black') div2.style.background='#444';
          if(item.name === 'crossfade') div2.style.background='linear-gradient(90deg,#111,#fff,#111)';
          if(item.name === 'autoplay_next') div2.style.background='#005bb5';
          div2.innerHTML = `<span class="transition-label" style="color:${item.name==='crossfade'?'black':'white'}">${label}</span>`;
          div.appendChild(div2);
        }
        const lbl = document.createElement('div');
        lbl.className = 'tile-label';
        lbl.textContent = item.name;
        div.appendChild(lbl);
        queueEl.appendChild(div);
      });
    }

    // --- Queue Navigation ---
    function nextInQueue() {
      if (!queue.length) return alert('Queue is empty');
      currentIdx = (currentIdx+1)%queue.length;
      renderQueue();
      previewQueueItem(queue[currentIdx]);
    }
    function prevInQueue() {
      if (!queue.length) return alert('Queue is empty');
      currentIdx = (currentIdx-1+queue.length)%queue.length;
      renderQueue();
      previewQueueItem(queue[currentIdx]);
    }

    function step(delta) {
      socket.emit('change_slide', { index:delta });
    }

    // --- Send Current Asset (with true crossfade and duration) ---
    let autoplayEnabled = false;
    function sendCurrent() {
      if (currentIdx < 0 || currentIdx >= queue.length) {
        return alert('Please queue and select an asset first.');
      }
      sendAsset(queue[currentIdx], currentIdx);
    }
    function sendAsset(asset, idx) {
      const fadeOut = document.getElementById('fadeout-checkbox').checked;
      const fadeIn  = document.getElementById('fadein-checkbox').checked;
      const autoplay= document.getElementById('autoplay-checkbox').checked;

      if (asset.type === "transition") {
        if (asset.name === "crossfade") {
          const nextIdx = (idx + 1) % queue.length;
          const nextAsset = queue[nextIdx];
          if (nextAsset && (nextAsset.type === 'slide' || nextAsset.type === 'video')) {
            currentIdx = nextIdx;
            renderQueue();
            let duration = parseFloat(document.getElementById('crossfade-duration').value) || 2.0;
            socket.emit('crossfade_to', { ...nextAsset, crossfade_duration: duration });
          }
        } else {
          socket.emit('transition', { name: asset.name });
        }
        return;
      }
      if (asset.type === "cue" && asset.name === "autoplay_next") {
        autoplayEnabled = true;
        alert("Autoplay Next enabled for next video.");
        return;
      }
      if (fadeOut) {
        socket.emit('fade_to_black');
        setTimeout(() => {
          socket.emit('display_asset', { ...asset, fadeIn, autoplay });
        }, 850);
      } else {
        socket.emit('display_asset', { ...asset, fadeIn, autoplay });
      }
      if (asset.type === 'video' && autoplayEnabled) {
        setupAutoplayListener();
        autoplayEnabled = false; // one shot
      }
    }

    function setupAutoplayListener() {
      const video = document.getElementById('current-audience-video');
      video.onended = function() {
        let nextIdx = (currentIdx + 1) % queue.length;
        let nextAsset = queue[nextIdx];
        let lookahead = queue[nextIdx + 1] || {};
        if (nextAsset && nextAsset.type === 'transition' && nextAsset.name === 'crossfade') {
          const nextNextIdx = (nextIdx + 1) % queue.length;
          const assetToFade = queue[nextNextIdx];
          if (assetToFade && (assetToFade.type === 'slide' || assetToFade.type === 'video')) {
            currentIdx = nextNextIdx;
            renderQueue();
            let duration = parseFloat(document.getElementById('crossfade-duration').value) || 2.0;
            socket.emit('crossfade_to', { ...assetToFade, crossfade_duration: duration });
            video.onended = null;
            return;
          }
        }
        if (nextAsset && (nextAsset.type === 'slide' || nextAsset.type === 'video')) {
          currentIdx = nextIdx;
          renderQueue();
          sendAsset(nextAsset, currentIdx);
        }
        video.onended = null;
      };
    }

    // --- Preview logic (your prior implementation) ---
    const previewImg   = document.getElementById('preview-img');
    const previewVid   = document.getElementById('preview-video');
    const previewSrc   = document.getElementById('preview-source');
    function previewQueueItem(item) {
      if (item.type === 'slide') {
        previewVid.style.display = 'none';
        previewImg.src = `/static/slides/${item.name}`;
        previewImg.style.display = 'block';
      } else if (item.type === 'video') {
        previewImg.style.display = 'none';
        previewSrc.src = `/static/media/${item.name}`;
        previewVid.load();
        previewVid.style.display = 'block';
      } else {
        previewVid.style.display = 'none';
        previewImg.style.display = 'none';
      }
    }

    // --- Live Audience View Reflection ---
    socket.on('sync_state', updateAudiencePanel);
    socket.on('display_asset', updateAudiencePanel);
    socket.on('play_pause_video', updateAudiencePanel);
    socket.on('set_playback_speed', updateAudiencePanel);
    socket.on('seek_video', updateAudiencePanel);

    function updateAudiencePanel(asset) {
      if (!asset) return;
      const currentAudienceImg = document.getElementById('current-audience-img');
      const currentAudienceVid = document.getElementById('current-audience-video');
      const currentAudienceSrc = document.getElementById('current-audience-source');
      if (asset.type === 'slide') {
        currentAudienceVid.style.display = 'none';
        currentAudienceImg.src = `/static/slides/${asset.name}`;
        currentAudienceImg.style.display = 'block';
      } else if (asset.type === 'video') {
        currentAudienceImg.style.display = 'none';
        currentAudienceSrc.src = `/static/media/${asset.name}`;
        currentAudienceVid.load();
        currentAudienceVid.style.display = 'block';
        currentAudienceVid.muted = true;
        currentAudienceVid.onloadedmetadata = function() {
          currentAudienceVid.currentTime = asset.video_time || 0;
          currentAudienceVid.playbackRate = asset.video_speed || 1.0;
          if (!asset.video_paused || asset.autoplay) {
            currentAudienceVid.play().catch(()=>{});
          } else {
            currentAudienceVid.pause();
          }
        };
      }
    }

    // --- Sortable Queue ---
    new Sortable(queueEl, {
      animation: 150,
      onEnd: function (evt) {
        const temp = queue[evt.oldIndex];
        queue.splice(evt.oldIndex, 1);
        queue.splice(evt.newIndex, 0, temp);
        if (currentIdx === evt.oldIndex) {
          currentIdx = evt.newIndex;
        } else if (evt.oldIndex < currentIdx && evt.newIndex >= currentIdx) {
          currentIdx--;
        } else if (evt.oldIndex > currentIdx && evt.newIndex <= currentIdx) {
          currentIdx++;
        }
        renderQueue();
      }
    });

    // --- Keyboard Shortcuts ---
    const playPauseBtn = document.getElementById('play-pause-button');
    document.addEventListener('keydown', function(event) {
      if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
      if (event.key === 'ArrowRight') {
        nextInQueue();
        event.preventDefault();
      } else if (event.key === 'ArrowLeft') {
        prevInQueue();
        event.preventDefault();
      } else if (event.key === 'Enter') {
        sendCurrent();
        event.preventDefault();
      } else if (event.code === 'Space') {
        playPauseBtn.click();
        event.preventDefault();
      }
    });

    // Play/Pause button logic
    playPauseBtn.onclick = () => {
      const video = document.getElementById('current-audience-video');
      if (video.style.display === 'block') {
        if (video.paused) { video.play(); } else { video.pause(); }
      }
      socket.emit('play_pause_video');
    };

    // --- INIT ---
    // Sticky crossfade duration
    const crossfadeInput = document.getElementById('crossfade-duration');
    if (localStorage.getItem('crossfade_duration')) {
      crossfadeInput.value = localStorage.getItem('crossfade_duration');
    }
    crossfadeInput.onchange = () => {
      localStorage.setItem('crossfade_duration', crossfadeInput.value);
    };
    renderQueue();
  </script>
</body>
</html>
