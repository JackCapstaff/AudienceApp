<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Control Panel</title>

  <!-- 1) Load a matching Socket.IO v4 client from CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.3.2/socket.io.min.js" integrity="sha512-N5JbZMETkl+0SZh5l8OA2VxSfF120owfQyy54iAXTJIKuqAn3A9TrNz1ypB55o8aSU5MxaodEgv74wGUvgUynQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>


  <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>

  <style>
    body { font-family: sans-serif; padding:1rem; }
    h1 { margin-top: 0; }
    #top-controls button { margin-right:0.5rem; padding:0.5rem 1rem; }
    #asset-grid, #queue {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px,1fr));
      gap:0.5rem;
      margin: 0.5rem 0;
      border:1px solid #ccc;
      padding:0.5rem;
      min-height: 120px;
    }
    .asset-tile, .queue-tile {
      position: relative;
      cursor: grab;
      border:2px solid transparent;
      border-radius:6px;
      overflow:hidden;
      background:#111;
    }
    .queue-tile.current {
      border-color:#007BFF;
    }
    .asset-tile img, .asset-tile video,
    .queue-tile img, .queue-tile video {
      width:100%; height:auto; object-fit:contain;
    }
    .tile-label {
      position:absolute; bottom:2px; left:2px;
      background:rgba(0,0,0,0.6); color:white;
      padding:1px 4px; font-size:0.75rem;
    }
    #send-options, #queue-controls { margin:0.5rem 0; }
    #send-options label, #queue-controls button { margin-right:0.5rem; }
    #preview-container, #current-audience-container {
      border: 1px solid #ccc;
      padding: 0.5rem;
      margin-bottom: 0.5rem;
      width: 50%; /* Take up 50% of the available space */
      box-sizing: border-box; /* Include padding and border in the width */
    }

    #preview-area {
        display: flex; /* Use flexbox to arrange containers side by side */
        justify-content: space-between; /* Add space between the containers */
        width: 100%;
    }

    #current-audience-img, #current-audience-video,
    #preview-img, #preview-video {
      max-width: 100%;
      display: none; /* Initially hidden */
    }
    #media-controls { margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>üéõÔ∏è Control Panel</h1>

  <div id="top-controls">
    <button id="black-button">Go to Black Screen</button>
    <button id="placeholder-button">Go to Placeholder</button>
    <button onclick="step(-1)">‚Üê Previous</button>
    <button onclick="step(1)">Next ‚Üí</button>
  </div>

  <h2>Asset Library (drag into queue)</h2>
  <div id="asset-grid">
    {% for slide in slides %}
      <div class="asset-tile" draggable="true"
           data-type="slide" data-name="{{ slide }}">
        <img src="/static/slides/{{ slide }}" alt="{{ slide }}"/>
        <div class="tile-label">{{ slide }}</div>
      </div>
    {% endfor %}
    {% for vid in videos %}
      <div class="asset-tile" draggable="true"
           data-type="video" data-name="{{ vid }}">
        <video muted>
          <source src="/static/media/{{ vid }}" type="video/mp4">
        </video>
        <div class="tile-label">{{ vid }}</div>
      </div>
    {% endfor %}
  </div>

  <h2>Queue</h2>
  <div id="queue"></div>
  <div id="queue-controls">
    <button onclick="prevInQueue()">‚Üê Prev in Queue</button>
    <button onclick="nextInQueue()">Next in Queue ‚Üí</button>
  </div>

  <div id="send-options">
    <label><input type="checkbox" id="fadeout-checkbox"/> Fade Out to Black</label>
    <label><input type="checkbox" id="fadein-checkbox"/> Fade In from Black</label>
    <label><input type="checkbox" id="autoplay-checkbox"/> Autoplay videos</label>
    <button onclick="sendCurrent()">Send Current</button>
  </div>

    <div id="queue-presets">
      <button id="save-preset-button">Save Preset</button>
      <button id="load-preset-button">Load Preset</button>
    </div>

  <div id="media-controls">
    <button id="play-pause-button">Play/Pause</button>
    <label for="playback-speed">Playback Speed:</label>
    <input type="number" id="playback-speed" min="0.25" max="2.0" step="0.25" value="1.0">
  </div>

  <div id="preview-area">
      <div id="current-audience-container">
        <h2>Current Audience View</h2>
        <img id="current-audience-img" alt="Current Audience Slide"/>
        <video id="current-audience-video" controls>
          <source id="current-audience-source" src="" type="video/mp4">
        </video>
      </div>

      <div id="preview-container">
        <h2>Preview</h2>
        <img  id="preview-img" alt="Slide preview"/>
        <video id="preview-video" controls>
          <source id="preview-source" src="" type="video/mp4">
        </video>
      </div>
  </div>

  <script>
    // --- 1. Setup Socket.IO client + debug ---
    const socket = io();
    console.log("üîó socket.io client loaded");
    socket.on("connect", () => console.log("‚úÖ socket connected, id=", socket.id));
    socket.on("connect_error", err => console.error("‚ùå socket connect_error:", err));

    // --- 2. Drag & Drop Queue ---
    const tiles = document.querySelectorAll('.asset-tile');
    const queueEl = document.getElementById('queue');
    let queue = [], currentIdx = -1;

    tiles.forEach(tile => {
      tile.addEventListener('dragstart', e => {
        e.dataTransfer.setData('text/plain', JSON.stringify({
          type: tile.dataset.type,
          name: tile.dataset.name
        }));
      });
      tile.addEventListener('click', () => {
        console.log("üì• tile clicked (queued):", tile.dataset);
        queue.push({ type: tile.dataset.type, name: tile.dataset.name });
        renderQueue();
      });
    });

    queueEl.addEventListener('dragover', e => e.preventDefault());
    queueEl.addEventListener('drop', e => {
      e.preventDefault();
      const data = JSON.parse(e.dataTransfer.getData('text/plain'));
      console.log("üì• dropped into queue:", data);
      queue.push(data);
      renderQueue();
    });

    function renderQueue() {
      queueEl.innerHTML = '';
      queue.forEach((item, i) => {
        const div = document.createElement('div');
        div.className = 'queue-tile' + (i === currentIdx ? ' current' : '');

        // Add click handler for highlighting
        div.addEventListener('click', () => {
          currentIdx = i;
          renderQueue(); // Re-render to update highlighting
        });

        if (item.type === 'slide') {
          const img = document.createElement('img');
          img.src = `/static/slides/${item.name}`;
          div.appendChild(img);
        } else {
          const vid = document.createElement('video');
          vid.muted = true;
          vid.src = `/static/media/${item.name}`;
          div.appendChild(vid);
        }
        const lbl = document.createElement('div');
        lbl.className = 'tile-label';
        lbl.textContent = item.name;
        div.appendChild(lbl);
        queueEl.appendChild(div);
      });
    }

    // --- 3. Queue Navigation ---
    function nextInQueue() {
      if (!queue.length) return alert('Queue is empty');
      currentIdx = (currentIdx+1)%queue.length;
      console.log("‚û°Ô∏è nextInQueue idx=", currentIdx);
      renderQueue();
    }
    function prevInQueue() {
      if (!queue.length) return alert('Queue is empty');
      currentIdx = (currentIdx-1+queue.length)%queue.length;
      console.log("‚¨ÖÔ∏è prevInQueue idx=", currentIdx);
      renderQueue();
    }

    // --- 4. Direct Controls ---
    document.getElementById('black-button').onclick = () => {
      console.log("‚ö´Ô∏è Fade to Black clicked");
      socket.emit('fade_to_black');
    };
    document.getElementById('placeholder-button').onclick = () => {
      console.log("üñºÔ∏è Go to Placeholder clicked");
      socket.emit('display_asset', {
        type:'slide', name:'holdingslide.jpg',
        autoplay:false, fadeIn:false
      });
    };
    function step(delta) {
      console.log("üî¢ step slides by", delta);
      socket.emit('change_slide', { index:delta });
    }

    // --- 5. Send Current Asset ---
    function sendCurrent() {
      if (currentIdx < 0 || currentIdx >= queue.length) {
        return alert('Please queue and select an asset first.');
      }
      sendAsset(queue[currentIdx]);
    }
    function sendAsset(asset) {
      const fadeOut = document.getElementById('fadeout-checkbox').checked;
      const fadeIn  = document.getElementById('fadein-checkbox').checked;
      const autoplay= document.getElementById('autoplay-checkbox').checked;
      console.log("üöÄ sendAsset", asset, { fadeOut, fadeIn, autoplay });

      const currentAudienceImg = document.getElementById('current-audience-img');
      const currentAudienceVid = document.getElementById('current-audience-video');
      const currentAudienceSrc = document.getElementById('current-audience-source');

      if (asset.type === 'slide') {
        currentAudienceVid.style.display = 'none';
        currentAudienceImg.src = `/static/slides/${asset.name}`;
        currentAudienceImg.style.display = 'block';
      } else if (asset.type === 'video') {
        currentAudienceImg.style.display = 'none';
        currentAudienceSrc.src = `/static/media/${asset.name}`;
        currentAudienceVid.load();
        currentAudienceVid.style.display = 'block';
        currentAudienceVid.muted = true; // Or false, as needed
        if (autoplay) {
            currentAudienceVid.play().catch(console.warn)
        }
      }

      if (fadeOut) {
        socket.emit('fade_to_black');
        setTimeout(() => {
          socket.emit('display_asset', { ...asset, fadeIn, autoplay });
        }, 850);
      } else {
        socket.emit('display_asset', { ...asset, fadeIn, autoplay });
      }
    }

    // --- 6. Preview Queue Item on Click ---
    const previewImg   = document.getElementById('preview-img');
    const previewVid   = document.getElementById('preview-video');
    const previewSrc   = document.getElementById('preview-source');
    queueEl.addEventListener('click', e => {
    const tile = e.target.closest('.queue-tile'); // Find the closest queue tile
    if (!tile) return; // If not a queue tile, exit

    e.preventDefault(); // Prevent default behavior (like text selection)

    const idx = Array.from(queueEl.children).indexOf(tile);
    if (idx < 0) return;
    const item = queue[idx];
    console.log("üëÄ previewing queue item:", item);
    if (item.type === 'slide') {
        previewVid.style.display = 'none';
        previewImg.src = `/static/slides/${item.name}`;
        previewImg.style.display = 'block';
    } else {
        previewImg.style.display = 'none';
        previewSrc.src = `/static/media/${item.name}`;
        previewVid.load();
        previewVid.style.display = 'block';
    }
});

    // --- 7. Media Controls ---
    document.getElementById('play-pause-button').addEventListener('click', () => {
      socket.emit('play_pause_video');
    });

    document.getElementById('playback-speed').addEventListener('change', (event) => {
      const speed = parseFloat(event.target.value);
      socket.emit('set_playback_speed', { speed: speed });
    });

    // --- 8. Sortable Queue ---
    new Sortable(queueEl, {
      animation: 150,
      onEnd: function (evt) {
        // Update the queue array based on the new order
        const temp = queue[evt.oldIndex];
        queue.splice(evt.oldIndex, 1);
        queue.splice(evt.newIndex, 0, temp);

        // Update currentIdx if necessary
        if (currentIdx === evt.oldIndex) {
            currentIdx = evt.newIndex;
        } else if (evt.oldIndex < currentIdx && evt.newIndex >= currentIdx) {
            currentIdx--;
        } else if (evt.oldIndex > currentIdx && evt.newIndex <= currentIdx) {
            currentIdx++;
        }

        renderQueue(); // Re-render the queue
      }
    });

        // --- 9. Save and Load Queue Presets ---
    document.getElementById('save-preset-button').addEventListener('click', () => {
      const presetName = prompt("Enter a name for the preset:");
      if (presetName) {
        localStorage.setItem(`queue_preset_${presetName}`, JSON.stringify(queue));
        alert(`Preset "${presetName}" saved!`);
      }
    });

    document.getElementById('load-preset-button').addEventListener('click', () => {
      const presetName = prompt("Enter the name of the preset to load:");
      if (presetName) {
        const savedQueue = localStorage.getItem(`queue_preset_${presetName}`);
        if (savedQueue) {
          queue = JSON.parse(savedQueue);
          currentIdx = -1; // Reset selected index
          renderQueue();
          alert(`Preset "${presetName}" loaded!`);
        } else {
          alert(`Preset "${presetName}" not found.`);
        }
      }
    });
  </script>
</body>
</html>
